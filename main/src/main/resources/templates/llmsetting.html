<!doctype html>
<html lang="en" data-bs-theme="auto" xmlns:th="http://www.thymeleaf.org">
<th:block th:insert="~{fragments/nav :: head(#{llm_setting})}"></th:block>
<body>
 <th:block th:insert="~{fragments/nav :: search}"></th:block>
 
<div class="container-fluid">
  <div class="row">
   <th:block th:insert="~{fragments/nav :: menu}"></th:block>
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
	  <th:block th:insert="~{fragments/nav :: breadcrumb}"></th:block>
		<!-- 智能分析说明 -->
		<div class="card shadow-sm border">
			<div class="card-header bg-light border-bottom py-2">
				<h5 class="mb-0">
					<i class="bi bi-motherboard me-2"></i> 大语言模型分析说明
				</h5>
			</div>
			<div class="card-body">
				<p class="text-muted">平台支持将设备数据与大语言模型(LLM)联动分析，自动触发智能决策。</p>
	
				<div class="row g-4">
					<!-- 流程说明 -->
					<div class="col-lg-6">
						<div class="card h-100 border">
							<div class="card-header bg-light border-bottom py-2">
								工作流程</div>
							<div class="card-body">
								<ul class="list-unstyled mb-0">
									<li class="d-flex align-items-center py-1"><i
										class="bi bi-arrow-right-short me-2"></i> 用户预编辑模板和变量</li>
									<li class="d-flex align-items-center py-1"><i
										class="bi bi-arrow-right-short me-2"></i> 设备触发实时数据上报</li>
									<li class="d-flex align-items-center py-1"><i
										class="bi bi-arrow-right-short me-2"></i> 系统匹配规则执行条件</li>
									<li class="d-flex align-items-center py-1"><i
										class="bi bi-arrow-right-short me-2"></i> 实时数据替换模板变量</li>
									<li class="d-flex align-items-center py-1"><i
										class="bi bi-arrow-right-short me-2"></i> 系统调用语言模型接口</li>
									<li class="d-flex align-items-center py-1"><i
										class="bi bi-arrow-right-short me-2"></i> 根据结果执行推送策略</li>
								</ul>
	
							</div>
						</div>
					</div>
	
					<!-- 示例说明 -->
					<div class="col-lg-6">
						<div class="card h-100 border">		
							<div class="card-header bg-light border-bottom p-0">
							    <ul class="nav nav-tabs">
							        <li class="nav-item">
							            <a class="nav-link active text-muted" 
							               data-bs-toggle="tab" 
							               href="#scene1">家庭安防</a>
							        </li>
							        <li class="nav-item">
							            <a class="nav-link text-muted" 
							               data-bs-toggle="tab" 
							               href="#scene2">车位检测</a>
							        </li>
							        <li class="nav-item">
							            <a class="nav-link text-muted" 
							               data-bs-toggle="tab" 
							               href="#scene3">厨房干烧</a>
							        </li>
							    </ul>
							</div>
							<div class="card-body">
								<div class="tab-content">
									<!-- 场景1 -->
									<div class="tab-pane fade show active" id="scene1">
										<div class="border p-2 rounded">
											<small class="d-block text-muted mb-2 mt-3"> <i
												class="bi bi-terminal me-1"></i> 模板举例：
											</small>
											<div class="bg-light p-2 rounded border">
												<code class="text-dark">
													"请根据家庭监控设备数据判断是否有小偷闯入：<br> -
													PIR触发时间{module_pir.active.time}，摄像头拍摄图片如下{module_camera.content}，地点卧室<br>
													- 回复仅接受：是/否<br>
												</code>
											</div>
											<small class="d-block text-muted mb-2"> <i
												class="bi bi-exclamation-square me-1"></i> 设备触发状态：
											</small>
											<p class="mb-2">
												<span class="badge bg-secondary">PIR传感器</span> 探测到人体活动<br>
												<span class="badge bg-secondary">摄像头</span> 拍摄到关联影像
											</p>
	
											<small class="d-block text-muted mb-2 mt-3"> <i
												class="bi bi-terminal me-1"></i> 发送文本到大语言模型接口：
											</small>
											<div class="bg-light p-2 rounded border">
												<code class="text-dark">
													"请根据家庭监控设备数据判断是否有小偷闯入：<br> -
													PIR触发时间21:00，摄像头拍摄图片如下，地点卧室<br>
													- 回复仅接受：是/否<br>
												</code>
											</div>
	
											<div class="mt-3">
												<span class="badge bg-secondary">模型响应：是</span> <small
													class="text-muted ms-2">（系统推送信息给用户提醒）</small>
											</div>
										</div>
									</div>	
									<!-- 场景2 -->
									<div class="tab-pane fade" id="scene2">
										<div class="border p-2 rounded">
											<small class="d-block text-muted mb-2 mt-3"> <i
												class="bi bi-terminal me-1"></i> 模板举例：
											</small>
											<div class="bg-light p-2 rounded border">
												<code class="text-dark">
													"以下提交的是停车场图片{module_camera.content}，请判断是否有空车位：<br> 
													- 回复仅接受：是/否<br>
												</code>
											</div>
											<small class="d-block text-muted mb-2"> <i
												class="bi bi-exclamation-square me-1"></i> 设备触发状态：
											</small>
											<p class="mb-2">
												<span class="badge bg-secondary">摄像头</span> 拍摄到最新照片
											</p>
	
											<small class="d-block text-muted mb-2 mt-3"> <i
												class="bi bi-terminal me-1"></i> 发送文本到大语言模型接口：
											</small>
											<div class="bg-light p-2 rounded border">
												<code class="text-dark">
													"以下提交的是停车场图片，请判断是否有空车位：<br> 
													- 回复仅接受：是/否<br>
												</code>
											</div>
	
											<div class="mt-3">
												<span class="badge bg-secondary">模型响应：是</span> <small
													class="text-muted ms-2">（系统推送信息给用户提醒）</small>
											</div>
										</div>
									</div>
									<!-- 场景3 -->
									<div class="tab-pane fade" id="scene3">
										<div class="border p-2 rounded">
											<small class="d-block text-muted mb-2 mt-3"> <i
												class="bi bi-terminal me-1"></i> 模板举例：
											</small>
											<div class="bg-light p-2 rounded border">
												<code class="text-dark">
													"请判断是否厨房灶台在燃烧，长时间无人，导致锅要被烧毁：<br> -
													PIR传感器探测到无人活动时间{module_pir.active.time}，并已持续{module_pir.inactive.seconds}秒，热成像传感器探测到的最高温度{module_thermal.temperature.max}摄氏度，最近60秒上升了{module_thermal.temperature.change(60)}摄氏度，摄像头拍摄图片如下{module_camera.content}，地点厨房<br> 
													- 回复仅接受：是/否<br>
												</code>
											</div>
											<small class="d-block text-muted mb-2"> <i
												class="bi bi-exclamation-square me-1"></i> 设备触发状态：
											</small>
											<p class="mb-2">
												<span class="badge bg-secondary">PIR传感器</span> 探测到无人活动<br>
												<span class="badge bg-secondary">热成像传感器</span> 探测到温度<br>
												<span class="badge bg-secondary">摄像头</span> 拍摄到关联影像
											</p>
	
											<small class="d-block text-muted mb-2 mt-3"> <i
												class="bi bi-terminal me-1"></i> 发送文本到大语言模型接口：
											</small>
											<div class="bg-light p-2 rounded border">
												<code class="text-dark">
													"请判断是否厨房灶台在燃烧，长时间无人，导致锅要被烧毁：<br> -
													PIR传感器探测到无人活动时间13:31:07，并已持续600秒，热成像传感器探测到的最高温度250摄氏度，最近60秒上升了30摄氏度，摄像头拍摄图片如下，地点厨房<br>
													- 回复仅接受：是/否<br>
												</code>
											</div>
	
											<div class="mt-3">
												<span class="badge bg-secondary">模型响应：是</span> <small
													class="text-muted ms-2">（系统推送信息给用户提醒）</small>
											</div>
										</div>
									</div>																	
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>


		<div class="row g-0">
            <!-- 规则列表 -->
            <div class="col-5 p-2">
                <div class="d-flex justify-content-between mb-3">
                    <h5>现有规则</h5>
                    <button class="btn btn-sm btn-primary" onclick="showForm()">新建规则</button>
                </div>
                <div id="ruleList" class="list-group">
                    <!-- 示例规则 -->
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="mb-1">温度控制规则</h6>
                                <div class="d-flex gap-1">
                                    <span class="badge bg-primary">温度传感器</span>
                                    <span class="badge bg-success">继电器模块</span>
                                </div>
                            </div>
                            <small class="text-muted">2023-08-20</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 规则详情 -->
            <div class="col-7 p-2 selected-preview">
                <div id="ruleDetail" class="h-100">
                    <h4 class="mb-4">新建规则</h4>
					<form onsubmit="createRule(event)">
					    <!-- 规则名称 -->
					    <div class="mb-4">
					        <label class="form-label">规则名称</label>
					        <input type="text" id="ruleName" class="form-control" required>
					    </div>
					
					    <!-- 模块选择区域 -->
					    <div class="row module-selector mb-5">
					        <div class="col-6">
					            <label class="form-label">可选模块</label>
					            <select id="moduleSelect" 
					                    class="form-select h-100" 
					                    multiple
					                    size="10"
					                    onchange="updateSelected()">
					                <!-- 模块选项 -->
					                <option value="temp">温度传感器</option>
					                <option value="humidity">湿度传感器</option>
					                <option value="light">光敏传感器</option>
					                <option value="relay">继电器模块</option>
					                <option value="motor">电机控制器</option>
					            </select>
					        </div>
					        
					        <div class="col-6">
					            <label class="form-label">已选模块</label>
					            <div id="selectedModules" class="border p-2 h-100 overflow-auto">
					                <!-- 已选模块动态插入 -->
					            </div>
					        </div>
					    </div>
					
					    <!-- 新增模块使用说明 -->
					    <div class="mb-4 collapse" id="moduleInstructions">
					        <div class="card">
					            <div class="card-header">模块使用说明</div>
					            <div class="card-body" id="instructionContent">
					                <!-- 动态加载说明内容 -->
					            </div>
					        </div>
					    </div>
					
						<!-- 触发条件设置 -->
						<div class="mb-4">
						    <div class="card shadow-sm">
						        <div class="card-header bg-light py-2 border-bottom">
						            <h6 class="mb-0">触发条件设置</h6>
						        </div>
						        <div class="card-body">
						            <div class="row g-3">
						                <div class="col-md-6">
						                    <label class="form-label">触发模块数量 (X)</label>
						                    <input type="number" 
						                           id="triggerCount" 
						                           class="form-control" 
						                           min="1" 
						                           value="1"
						                           :max="selectedModuleCount"
						                           required>
						                    <div class="form-text text-muted mt-1">所选模块任一上报数据后，如果所选模块(含刚上报模块)中X个模块在最近Y秒内有上报则触发</div>
						                </div>
						                <div class="col-md-6">
						                    <label class="form-label">时间窗口 (Y 秒)</label>
						                    <input type="number" 
						                           id="timeWindow" 
						                           class="form-control" 
						                           min="0" 
						                           max="3600" 
						                           value="5"
						                           required>
						                    <div class="form-text text-muted mt-1">范围：0-3600秒</div>
						                </div>
                <!-- 新增设备关联输入 -->
                <div class="col-12">
                    <label for="deviceIds" class="form-label">关联设备编号(设备上粘贴的标签)</label>
                    <textarea 
                        id="deviceIds"
                        class="form-control" 
                        rows="3"
                        placeholder="示例: 
24587cd6ef0c 24587cd6ef0d 24587cd6ef0e
24587cd6ef0f"
                        title="支持逗号、空格或换行分隔"
                    ></textarea>
                    <div class="form-text text-muted mt-1">
                        可输入多个设备ID，使用以下任意分隔符：
                        <span class="badge bg-secondary mx-1">,</span>
                        <span class="badge bg-secondary mx-1">空格</span>
                        <span class="badge bg-secondary mx-1">换行</span>
                    </div>
                </div>						                
						                
						            </div>
						        </div>
						    </div>
						</div>
					
					    <!-- 操作按钮 -->
					    <div class="mt-4 d-flex justify-content-end gap-2">
					        <button type="button" class="btn btn-secondary" onclick="cancelCreate()">取消</button>
					        <button type="submit" class="btn btn-primary">创建规则</button>
					    </div>
					</form>
                </div>
            </div>
        </div>

    </main>
   <th:block th:insert="~{fragments/nav :: modalError}"></th:block>
   <th:block th:insert="~{fragments/nav :: modalConfirm}"></th:block>
   <th:block th:insert="~{fragments/nav :: modalCreateItem}"></th:block>
  </div>
</div>

<th:block th:insert="~{fragments/nav :: scriptFunctions}"></th:block>
<script  th:inline="javascript">
//已选模块数据
let selectedModules = [];
const moduleInstructions = {
	    temp: "温度传感器：监测环境温度，支持-40℃~125℃范围，每5秒上报一次数据",
	    humidity: "湿度传感器：监测空气湿度，量程0-100%RH，精度±2%RH",
	    light: "光敏传感器：检测光照强度，量程0-100000Lux，响应时间＜20ms",
	    relay: "继电器模块：最大负载10A/250VAC，支持常开/常闭两种模式",
	    motor: "电机控制器：支持PWM调速，输入电压DC12-24V，最大电流5A"
	};
// 更新已选模块显示
function updateSelected() {
    const select = document.getElementById('moduleSelect');
    const container = document.getElementById('selectedModules');
    const existingValues = Array.from(container.children).map(item => item.dataset.value);
    const newSelections = Array.from(select.selectedOptions).filter(option => !existingValues.includes(option.value));
    
    const newTags = newSelections.map(option => `
        <div class="badge module-tag bg-primary p-2 mb-2 me-2" 
             data-value="${option.value}">
            ${option.text}
            <span class="delete-btn ms-2" 
                  onclick="deselectModule('${option.value}')"
                  style="cursor:pointer">×</span>
        </div>
    `).join('');

    container.innerHTML += newTags;
    select.selectedIndex = -1;

    const selectedValues = [...new Set([...existingValues, ...newSelections.map(m => m.value)])];
    const countElement = document.getElementById('moduleCount');
    const triggerInput = document.getElementById('triggerCount');
    const instructionPanel = document.getElementById('moduleInstructions');
    const instructionContent = document.getElementById('instructionContent');

    countElement.textContent = selectedValues.length;
    triggerInput.max = selectedValues.length;
    
    if (selectedValues.length > 0) {
        instructionPanel.classList.add('show');
        instructionContent.innerHTML = selectedValues.map(v => `
            <p class="mb-2">${moduleInstructions[v]}</p>
        `).join('');
    } else {
        instructionPanel.classList.remove('show');
        instructionContent.innerHTML = '';
    }
}


//删除模块时同步移除
function deselectModule(value) {
    const container = document.getElementById('selectedModules');
    const target = container.querySelector(`[data-value="${value}"]`);
    if(target) target.remove();
}
// 创建规则
function createRule(e) {
    e.preventDefault();
    
    const ruleName = document.getElementById('ruleName').value;
    const modules = selectedModules.map(m => m.text);
    
    if(!ruleName || modules.length === 0) {
        alert('请填写规则名称并选择至少一个模块');
        return;
    }

    // 添加到规则列表
    const ruleItem = document.createElement('div');
    ruleItem.className = 'list-group-item';
    ruleItem.innerHTML = `
        <div class="d-flex justify-content-between">
            <div>
                <h6 class="mb-1">${ruleName}</h6>
                <div class="d-flex gap-1">
                    ${modules.map(m => `<span class="badge bg-primary">${m}</span>`).join('')}
                </div>
            </div>
            <small class="text-muted">${new Date().toLocaleDateString()}</small>
        </div>
    `;
    
    document.getElementById('ruleList').appendChild(ruleItem);
    resetForm();
}

// 重置表单
function resetForm() {
    document.getElementById('ruleName').value = '';
    document.getElementById('moduleSelect').selectedIndex = -1;
    updateSelected();
}

// 取消创建
function cancelCreate() {
    if(confirm('确认放弃当前编辑？')) resetForm();
}
</script>
</body>
</html>
